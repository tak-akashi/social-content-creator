> **ステータス: 実装済み**
> 最終更新: 2026-02-13

# 技術仕様書 (Architecture Design Document)

## テクノロジースタック

### 言語・ランタイム

| 技術 | バージョン |
|------|-----------|
| Python | 3.12+ |
| uv | 0.5+ |

### フレームワーク・ライブラリ

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| httpx | 0.27+ | HTTP通信 | async対応、モダンなAPI |
| pydantic | 2.0+ | データバリデーション | 型安全なデータモデル定義 |
| python-frontmatter | 1.1+ | Markdownメタデータ | 記事ファイルのfront matter解析 |
| jinja2 | 3.1+ | テンプレートエンジン | 記事テンプレートのレンダリング |
| authlib | 1.3+ | OAuth認証 | X API OAuth 1.0a認証 |
| markdown | 3.10+ | Markdown→HTML変換 | 記事本文のHTML変換に使用 |
| python-dotenv | 1.0+ | 環境変数読み込み | .envファイルの読み込み |
| google-genai | 1.63+ | Gemini API | GeminiCollector用 |

### 開発ツール

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| pytest | 8.0+ | テスト | Python標準テストフレームワーク |
| pytest-asyncio | 0.24+ | 非同期テスト | async関数のテストサポート |
| pytest-cov | 7.0+ | カバレッジ計測 | テストカバレッジの可視化 |
| ruff | 0.8+ | Lint・フォーマット | 高速、包括的なルールセット |
| black | 24.0+ | コードフォーマット | 一貫したコードスタイル |
| mypy | 1.14+ | 型チェック | 静的型安全性の確保 |
| pytest-mock | 3.14+ | モック | テスト用モック機能 |
| respx | 0.22+ | HTTPモック | httpxリクエストのモック |

## アーキテクチャパターン

### レイヤードアーキテクチャ（2層構造）

```
┌──────────────────────────────────────────┐
│   スキル層（Claude Code Skills）          │ ← ユーザーインターフェース
│   ・/create-blog-post コマンド処理        │
│   ・対話的な記事レビュー・修正             │
├──────────────────────────────────────────┤
│   ツール層（Python バックエンド）          │ ← ビジネスロジック + データ
│   ┌────────────┬──────────┬───────────┐  │
│   │ generators │collectors│ publishers│  │
│   │ 記事生成   │情報収集   │ 投稿連携  │  │
│   └────────────┴──────────┴───────────┘  │
│   ┌────────────┬──────────────────────┐  │
│   │ templates  │ models (データモデル) │  │
│   └────────────┴──────────────────────┘  │
└──────────────────────────────────────────┘
         ↕              ↕            ↕          ↕
    ローカルFS     外部API群    WordPress    X API v2
```

#### スキル層（Claude Code Skills）
- **責務**: ユーザーとの対話インターフェース、コマンド解析、結果表示
- **許可される操作**: ツール層のPython関数呼び出し
- **禁止される操作**: 外部APIへの直接アクセス（必ずツール層を経由）

#### ツール層（Python バックエンド）
- **責務**: 記事生成、情報収集、投稿処理、データモデル管理
- **サブモジュール**:
  - `generators/`: 記事生成ロジック
  - `collectors/`: 情報収集ツール群
  - `publishers/`: 投稿先プラットフォーム連携
  - `templates/`: コンテンツタイプ別テンプレート
  - `models/`: データモデル定義

### 設計原則

1. **スキル層とツール層の分離**: UIロジックとビジネスロジックを明確に分離
2. **Protocol による依存性逆転**: 具象クラスではなくProtocolに依存
3. **Collector パターン**: 情報収集を共通インターフェースで統一し、新しい情報源を容易に追加
4. **Publisher パターン**: 投稿先を共通インターフェースで統一し、Phase 2以降の拡張に備える

## データ永続化戦略

### ストレージ方式

| データ種別 | ストレージ | フォーマット | 理由 |
|-----------|----------|-------------|------|
| 生成記事 | ローカルファイル | Markdown + front matter | 人間が読みやすい、Git管理可能 |
| テンプレート | Pythonモジュール | Pydantic BaseModel | 型安全、IDEサポート |
| 設定情報 | 環境変数 | .env | セキュリティ、デプロイ容易性 |

### 記事保存ディレクトリ構造

記事はステータスに応じて `docs/drafts/`（下書き）と `docs/posts/`（投稿済み）に分離して管理する。

#### ドラフト（下書き）

```
docs/drafts/
├── weekly-ai-news/
│   └── YYYYMMDD-{slug}.md
├── paper-review/
│   └── YYYYMMDD-{slug}.md
├── project-intro/
│   └── YYYYMMDD-{slug}.md
├── tool-tips/
│   └── YYYYMMDD-{slug}.md
├── market-analysis/
│   └── YYYYMMDD-{slug}.md
├── ml-practice/
│   └── YYYYMMDD-{slug}.md
├── cv/
│   └── YYYYMMDD-{slug}.md
└── feature/
    └── YYYYMMDD-{slug}.md
```

- コンテンツタイプ（ジャンル）別にディレクトリを分割し、下書きの管理を容易にする
- `YYYYMMDD` は**作成日**（ドラフトを生成した日）
- WordPress投稿完了後、`docs/posts/` に移動する

#### 投稿済み

```
docs/posts/
└── YYYY/
    └── MM/
        └── YYYYMMDD-{content_type}-{slug}.md
```

- 年/月でディレクトリを分割し、記事の検索を容易にする
- ファイル名にコンテンツタイプを含め、タイプ別の一覧を取得しやすくする
- `YYYYMMDD` は**投稿日**（WordPressに投稿した日）であり、ドラフト作成日とは異なる場合がある

#### ライフサイクル

```
生成 → docs/drafts/{content_type}/YYYYMMDD(作成日)-{slug}.md に保存
  → レビュー・編集（同ファイルを更新）
  → WordPress投稿
  → docs/posts/YYYY/MM/YYYYMMDD(投稿日)-{content_type}-{slug}.md に移動（日付はリネーム）
```

## パフォーマンス要件

### レスポンスタイム

| 操作 | 目標時間 | 測定環境 |
|------|---------|---------|
| テンプレート読み込み | 100ms以内 | ローカル |
| Web検索結果取得 | 30秒以内 | インターネット接続環境 |
| URL内容取得・要約 | 30秒以内 | インターネット接続環境 |
| WordPress投稿 | 10秒以内 | インターネット接続環境 |
| X投稿（1ツイート） | 10秒以内 | インターネット接続環境 |
| 記事ローカル保存 | 500ms以内 | ローカル |

### リソース使用量

| リソース | 上限 | 理由 |
|---------|------|------|
| メモリ | 512MB | 記事生成に十分、他プロセスへの影響を最小化 |
| ディスク | 100MB | 記事ファイル蓄積（年間500記事相当） |

## セキュリティアーキテクチャ

### データ保護

- **暗号化**: WordPress API通信はHTTPS必須
- **アクセス制御**: ファイルパーミッション 600（.envファイル）
- **機密情報管理**: 以下の情報を環境変数で管理
  - `WORDPRESS_URL`: WordPressサイトURL
  - `WORDPRESS_USER`: WordPressユーザー名
  - `WORDPRESS_APP_PASSWORD`: Application Passwords トークン
  - `X_API_KEY`: X API Key（OAuth 1.0a）
  - `X_API_SECRET`: X API Secret（OAuth 1.0a）
  - `X_ACCESS_TOKEN`: X Access Token（OAuth 1.0a）
  - `X_ACCESS_TOKEN_SECRET`: X Access Token Secret（OAuth 1.0a）

### 入力検証

- **バリデーション**: URL形式、コンテンツタイプ名の検証
- **サニタイゼーション**: HTML/Markdownインジェクション防止
- **エラーハンドリング**: 機密情報（APIキー等）をエラーメッセージに含めない

## スケーラビリティ設計

### データ増加への対応

- **想定データ量**: 年間150〜200記事（週2〜3回）
- **パフォーマンス劣化対策**: 年/月でディレクトリ分割、検索時のフィルタリング
- **アーカイブ戦略**: 不要（記事ファイルは軽量のため蓄積で問題なし）

### 機能拡張性

- **Collector拡張**: `CollectorProtocol` を実装した新クラスを追加するだけで情報源を拡張
- **Publisher拡張**: `PublisherProtocol` を実装した新クラスを追加するだけで投稿先を拡張（WordPress、X投稿を実装済み）
- **テンプレート拡張**: `src/templates/` に新ファイルを追加するだけで新コンテンツタイプに対応
- **設定のカスタマイズ**: テンプレートの文字数目安、セクション構成を設定可能

## テスト戦略

### ユニットテスト
- **フレームワーク**: pytest + pytest-asyncio
- **対象**: generators, collectors, publishers の各モジュール
- **カバレッジ目標**: 80%

### 統合テスト
- **方法**: 複数コンポーネントを結合してテスト
- **対象**: 記事生成フロー（Generator + Template + Collector）

### E2Eテスト
- **ツール**: pytest
- **シナリオ**: コマンド実行→記事生成→ローカル保存→WordPress投稿（モック）

## 技術的制約

### 環境要件
- **OS**: macOS（主要開発環境）、Linux対応
- **最小メモリ**: 256MB
- **必要ディスク容量**: 50MB（プロジェクト本体）
- **必要な外部依存**:
  - インターネット接続（情報収集、WordPress投稿）
  - Claude Code（スキル層の実行）
  - WordPress サイト（投稿先）

### パフォーマンス制約
- 記事生成速度はClaude APIのレスポンス速度に依存
- 情報収集速度は外部APIのレスポンス速度に依存

### セキュリティ制約
- WordPress Application Passwords の有効期限管理が必要
- Notion MCP は Claude Code 環境でのみ利用可能

## 依存関係管理

| ライブラリ | 用途 | バージョン管理方針 |
|-----------|------|-------------------|
| httpx | HTTP通信 | マイナーバージョン範囲指定 |
| authlib | OAuth認証 | メジャーバージョン固定（1.x） |
| pydantic | データモデル | メジャーバージョン固定（2.x） |
| python-frontmatter | Markdownメタデータ | 最新 |
| jinja2 | テンプレートエンジン | メジャーバージョン固定（3.x） |
| pytest | テスト | 最新 |
| ruff | Lint | 最新 |
| mypy | 型チェック | 最新 |
